name: FastAPI CI

on:
    pull_request:
        branches: [main, develop]
    push:
        branches: [main]

jobs:
    test:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:15
                env:
                    POSTGRES_USER: test_user
                    POSTGRES_PASSWORD: test_password
                    POSTGRES_DB: test_db
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd="pg_isready -U test_user"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5

        env:
            DATABASE_URL: postgresql+psycopg2://test_user:test_password@localhost:5432/test_db
            AWS_REGION: us-east-1
  			USER_POOL_ID: dummy
  			CLIENT_ID: dummy

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install pytest pytest-cov black ruff mypy

            - name: Lint
              run: ruff check .

            - name: Type check
              run: mypy .

            - name: Wait for Postgres
              run: |
                  for i in {1..10}; do
                    pg_isready -h localhost -p 5432 -U test_user && break
                    sleep 2
                  done

            #- name: Run tests
            #  run: pytest --cov=app --cov-report=term-missing

            - name: Import app
              run: python -c "from app.app import app"
